---
description: Выявить недостаточно специфицированные области в текущей спецификации функции, задав до 5 высокоцелевых уточняющих вопросов и закодировав ответы обратно в спецификацию.
handoffs: 
  - label: Построить технический план
    agent: speckit.plan
    prompt: Создать план для спецификации. Я строю с...
---

## Ввод пользователя

```text
$ARGUMENTS
```

Вы **ДОЛЖНЫ** учитывать ввод пользователя перед продолжением (если он не пустой).

## План

Цель: Обнаружить и уменьшить неоднозначность или отсутствующие точки решений в активной спецификации функции и записать уточнения непосредственно в файл спецификации.

Примечание: Ожидается, что этот рабочий процесс уточнения будет запущен (и завершен) ПЕРЕД вызовом `/speckit.plan`. Если пользователь явно заявляет, что пропускает уточнение (например, исследовательский спайк), вы можете продолжить, но должны предупредить, что риск последующей переработки увеличивается.

Шаги выполнения:

1. Запустите `.specify/scripts/powershell/check-prerequisites.ps1 -Json -PathsOnly` из корня репозитория **один раз** (комбинированный режим `--json --paths-only` / `-Json -PathsOnly`). Распарсите минимальные поля JSON payload:
   - `FEATURE_DIR`
   - `FEATURE_SPEC`
   - (Опционально захватите `IMPL_PLAN`, `TASKS` для будущих связанных потоков.)
   - Если парсинг JSON не удался, прервите и инструктируйте пользователя перезапустить `/speckit.specify` или проверить окружение ветки функции.
   - Для одинарных кавычек в аргументах типа "I'm Groot" используйте синтаксис экранирования: например, 'I'\''m Groot' (или двойные кавычки, если возможно: "I'm Groot").

2. Загрузите текущий файл спецификации. Выполните структурированное сканирование неоднозначности и покрытия, используя эту таксономию. Для каждой категории пометьте статус: Ясно / Частично / Отсутствует. Создайте внутреннюю карту покрытия для приоритизации (не выводите сырую карту, если вопросы не будут заданы).

   Функциональная область и поведение:
   - Основные цели пользователя и критерии успеха
   - Явные декларации вне области
   - Различение ролей пользователей / персон

   Домен и модель данных:
   - Сущности, атрибуты, связи
   - Правила идентичности и уникальности
   - Переходы жизненного цикла/состояний
   - Предположения объема данных / масштаба

   Взаимодействие и UX поток:
   - Критические пользовательские пути / последовательности
   - Состояния ошибки/пустоты/загрузки
   - Примечания доступности или локализации

   Нефункциональные атрибуты качества:
   - Производительность (цели задержки, пропускной способности)
   - Масштабируемость (горизонтальная/вертикальная, лимиты)
   - Надежность и доступность (время работы, ожидания восстановления)
   - Наблюдаемость (логирование, метрики, сигналы трассировки)
   - Безопасность и конфиденциальность (authN/Z, защита данных, предположения об угрозах)
   - Соответствие / регуляторные ограничения (если есть)

   Интеграция и внешние зависимости:
   - Внешние сервисы/API и режимы отказа
   - Форматы импорта/экспорта данных
   - Предположения протокола/версионирования

   Граничные случаи и обработка отказов:
   - Негативные сценарии
   - Ограничение скорости / дросселирование
   - Разрешение конфликтов (например, одновременные правки)

   Ограничения и компромиссы:
   - Технические ограничения (язык, хранилище, хостинг)
   - Явные компромиссы или отклоненные альтернативы

   Терминология и согласованность:
   - Канонические термины глоссария
   - Избегаемые синонимы / устаревшие термины

   Сигналы завершения:
   - Проверяемость критериев приемки
   - Измеримые индикаторы стиля Definition of Done

   Разное / Плейсхолдеры:
   - Маркеры TODO / неразрешенные решения
   - Расплывчатые прилагательные ("robust", "intuitive"), не имеющие квантификации

   Для каждой категории со статусом Частично или Отсутствует добавьте возможность вопроса-кандидата, если:
   - Уточнение не существенно изменит стратегию реализации или валидации
   - Информация лучше отложена до фазы планирования (отметьте внутренне)

3. Сгенерируйте (внутренне) приоритизированную очередь вопросов-кандидатов для уточнения (максимум 5). НЕ выводите их все сразу. Примените эти ограничения:
    - Максимум 10 вопросов всего за всю сессию.
    - Каждый вопрос должен быть отвечаемым ЛИБО:
       - Коротким множественным выбором (2–5 различных, взаимоисключающих опций), ЛИБО
       - Одним словом / короткой фразой (явно ограничьте: "Ответ в <=5 словах").
    - Включайте только вопросы, ответы на которые существенно влияют на архитектуру, моделирование данных, декомпозицию задач, дизайн тестов, поведение UX, операционную готовность или валидацию соответствия.
    - Обеспечьте баланс покрытия категорий: попытайтесь охватить категории с наивысшим влиянием, неразрешенные первыми; избегайте задавать два вопроса с низким влиянием, когда одна область с высоким влиянием (например, позиция безопасности) неразрешенна.
    - Исключите уже отвеченные вопросы, тривиальные стилистические предпочтения или детали выполнения уровня плана (если не блокируют корректность).
    - Предпочитайте уточнения, которые снижают риск последующей переработки или предотвращают невыровненные тесты приемки.
    - Если более 5 категорий остаются неразрешенными, выберите топ-5 по эвристике (Влияние * Неопределенность).

4. Последовательный цикл вопросов (интерактивный):
    - Представляйте РОВНО ОДИН вопрос за раз.
    - Для вопросов с множественным выбором:
       - **Проанализируйте все опции** и определите **наиболее подходящую опцию** на основе:
          - Лучших практик для типа проекта
          - Общих паттернов в похожих реализациях
          - Снижения риска (безопасность, производительность, поддерживаемость)
          - Выравнивания с любыми явными целями проекта или ограничениями, видимыми в спецификации
       - Представьте вашу **рекомендуемую опцию** заметно вверху с ясным обоснованием (1-2 предложения, объясняющие, почему это лучший выбор).
       - Форматируйте как: `**Рекомендуется:** Опция [X] - <обоснование>`
       - Затем отобразите все опции как таблицу Markdown:

       | Опция | Описание |
       |-------|----------|
       | A | <Описание опции A> |
       | B | <Описание опции B> |
       | C | <Описание опции C> (добавьте D/E по необходимости до 5) |
       | Короткий | Предоставьте другой короткий ответ (<=5 слов) (Включайте только если свободная форма уместна) |

       - После таблицы добавьте: `Вы можете ответить буквой опции (например, "A"), принять рекомендацию, сказав "yes" или "recommended", или предоставить свой короткий ответ.`
    - Для стиля короткого ответа (нет значимых дискретных опций):
       - Предоставьте ваш **предложенный ответ** на основе лучших практик и контекста.
       - Форматируйте как: `**Предложено:** <ваш предложенный ответ> - <краткое обоснование>`
       - Затем выведите: `Формат: Короткий ответ (<=5 слов). Вы можете принять предложение, сказав "yes" или "suggested", или предоставить свой ответ.`
    - После ответа пользователя:
       - Если пользователь отвечает "yes", "recommended" или "suggested", используйте вашу ранее указанную рекомендацию/предложение как ответ.
       - Иначе валидируйте, что ответ соответствует одной опции или соответствует ограничению <=5 слов.
       - Если неоднозначно, попросите быстрое уточнение (подсчет все еще принадлежит тому же вопросу; не продвигайтесь).
       - Как только удовлетворительно, запишите это в рабочую память (пока не записывайте на диск) и переходите к следующему вопросу в очереди.
    - Остановите задавание дальнейших вопросов, когда:
       - Все критические неоднозначности разрешены рано (оставшиеся элементы очереди становятся ненужными), ИЛИ
       - Пользователь сигнализирует завершение ("done", "good", "no more"), ИЛИ
       - Вы достигли 5 заданных вопросов.
    - Никогда не раскрывайте будущие вопросы в очереди заранее.
    - Если в начале нет валидных вопросов, немедленно сообщите об отсутствии критических неоднозначностей.

5. Интеграция после КАЖДОГО принятого ответа (подход инкрементального обновления):
    - Поддерживайте представление спецификации в памяти (загруженное один раз в начале) плюс сырое содержимое файла.
    - Для первого интегрированного ответа в этой сессии:
       - Убедитесь, что раздел `## Clarifications` существует (создайте его сразу после раздела контекста/обзора высшего уровня согласно шаблону спецификации, если отсутствует).
       - Под ним создайте (если отсутствует) подзаголовок `### Session YYYY-MM-DD` на сегодня.
    - Добавьте маркерную строку сразу после принятия: `- Q: <вопрос> → A: <финальный ответ>`.
    - Затем немедленно примените уточнение к наиболее подходящему разделу(ам):
       - Функциональная неоднозначность → Обновите или добавьте маркер в Функциональные требования.
       - Взаимодействие пользователя / различение акторов → Обновите Пользовательские истории или подраздел Акторов (если присутствует) с уточненной ролью, ограничением или сценарием.
       - Форма данных / сущности → Обновите Модель данных (добавьте поля, типы, связи), сохраняя порядок; кратко отметьте добавленные ограничения.
       - Нефункциональное ограничение → Добавьте/измените измеримые критерии в разделе Нефункциональные / Атрибуты качества (преобразуйте расплывчатое прилагательное в метрику или явную цель).
       - Граничный случай / негативный поток → Добавьте новый маркер под Граничные случаи / Обработка ошибок (или создайте такой подраздел, если шаблон предоставляет плейсхолдер для него).
       - Конфликт терминологии → Нормализуйте термин по всей спецификации; сохраните оригинал только при необходимости, добавив `(ранее назывался "X")` один раз.
    - Если уточнение делает недействительным более раннее неоднозначное утверждение, замените это утверждение вместо дублирования; не оставляйте устаревшего противоречивого текста.
    - Сохраняйте файл спецификации ПОСЛЕ каждой интеграции, чтобы минимизировать риск потери контекста (атомарная перезапись).
    - Сохраняйте форматирование: не переупорядочивайте несвязанные разделы; сохраняйте иерархию заголовков нетронутой.
    - Сохраняйте каждое вставленное уточнение минимальным и проверяемым (избегайте нарративного дрейфа).

6. Валидация (выполняется после КАЖДОЙ записи плюс финальный проход):
   - Сессия уточнений содержит ровно один маркер на принятый ответ (без дубликатов).
   - Всего заданных (принятых) вопросов ≤ 5.
   - Обновленные разделы не содержат затянувшихся расплывчатых плейсхолдеров, которые новый ответ должен был разрешить.
   - Не остается противоречивых более ранних утверждений (проверьте на удаленные теперь-недействительные альтернативные выборы).
   - Структура Markdown валидна; разрешены только новые заголовки: `## Clarifications`, `### Session YYYY-MM-DD`.
   - Согласованность терминологии: один и тот же канонический термин используется во всех обновленных разделах.

7. Запишите обновленную спецификацию обратно в `FEATURE_SPEC`.

8. Отчет о завершении (после окончания цикла вопросов или раннего завершения):
   - Количество заданных и отвеченных вопросов.
   - Путь к обновленной спецификации.
   - Затронутые разделы (список имен).
   - Таблица сводки покрытия, перечисляющая каждую категорию таксономии со статусом: Разрешен (было Частично/Отсутствует и обработано), Отложен (превышает квоту вопросов или лучше подходит для планирования), Ясно (уже достаточно), Выдающийся (все еще Частично/Отсутствует, но с низким влиянием).
   - Если остаются Выдающиеся или Отложенные, рекомендуйте, продолжать ли к `/speckit.plan` или запустить `/speckit.clarify` снова позже после плана.
   - Предложенная следующая команда.

Правила поведения:

- Если не найдено значимых неоднозначностей (или все потенциальные вопросы были бы с низким влиянием), ответьте: "Не обнаружено критических неоднозначностей, достойных формального уточнения." и предложите продолжить.
- Если файл спецификации отсутствует, инструктируйте пользователя сначала запустить `/speckit.specify` (не создавайте новую спецификацию здесь).
- Никогда не превышайте 5 заданных вопросов всего (повторные попытки уточнения для одного вопроса не считаются новыми вопросами).
- Избегайте спекулятивных вопросов о технологическом стеке, если отсутствие не блокирует функциональную ясность.
- Уважайте сигналы раннего завершения пользователя ("stop", "done", "proceed").
- Если вопросы не заданы из-за полного покрытия, выведите компактную сводку покрытия (все категории Ясно), затем предложите продвижение.
- Если квота достигнута с оставшимися неразрешенными категориями с высоким влиянием, явно пометьте их под Отложенными с обоснованием.

Контекст для приоритизации: $ARGUMENTS
