---
description: Выполнить неразрушающий анализ согласованности и качества между артефактами spec.md, plan.md и tasks.md после генерации задач.
---

## Ввод пользователя

```text
$ARGUMENTS
```

Вы **ДОЛЖНЫ** учитывать ввод пользователя перед продолжением (если он не пустой).

## Цель

Выявить несогласованности, дублирования, неоднозначности и недостаточно специфицированные элементы в трех основных артефактах (`spec.md`, `plan.md`, `tasks.md`) перед реализацией. Эта команда ДОЛЖНА запускаться только после того, как `/speckit.tasks` успешно создал полный `tasks.md`.

## Ограничения работы

**СТРОГО ТОЛЬКО ЧТЕНИЕ**: **НЕ** изменяйте файлы. Выведите структурированный отчет об анализе. Предложите опциональный план исправления (пользователь должен явно одобрить перед любыми последующими командами редактирования, которые будут вызваны вручную).

**Авторитет конституции**: Конституция проекта (`.specify/memory/constitution.md`) **не подлежит обсуждению** в рамках этого анализа. Конфликты с конституцией автоматически КРИТИЧНЫ и требуют корректировки spec, plan или tasks — не разбавления, переинтерпретации или тихого игнорирования принципа. Если сам принцип нуждается в изменении, это должно произойти в отдельном, явном обновлении конституции вне `/speckit.analyze`.

## Шаги выполнения

### 1. Инициализация контекста анализа

Запустите `.specify/scripts/powershell/check-prerequisites.ps1 -Json -RequireTasks -IncludeTasks` один раз из корня репозитория и распарсите JSON для FEATURE_DIR и AVAILABLE_DOCS. Выведите абсолютные пути:

- SPEC = FEATURE_DIR/spec.md
- PLAN = FEATURE_DIR/plan.md
- TASKS = FEATURE_DIR/tasks.md

Прервать с сообщением об ошибке, если какой-либо обязательный файл отсутствует (инструкция пользователю запустить отсутствующую команду-предварительное условие).
Для одинарных кавычек в аргументах типа "I'm Groot" используйте синтаксис экранирования: например, 'I'\''m Groot' (или двойные кавычки, если возможно: "I'm Groot").

### 2. Загрузка артефактов (Прогрессивное раскрытие)

Загружайте только минимально необходимый контекст из каждого артефакта:

**Из spec.md:**

- Обзор/Контекст
- Функциональные требования
- Нефункциональные требования
- Пользовательские истории
- Граничные случаи (если присутствуют)

**Из plan.md:**

- Выборы архитектуры/стека
- Ссылки на модель данных
- Фазы
- Технические ограничения

**Из tasks.md:**

- ID задач
- Описания
- Группировка по фазам
- Маркеры параллельности [P]
- Ссылки на пути файлов

**Из конституции:**

- Загрузить `.specify/memory/constitution.md` для валидации принципов

### 3. Построение семантических моделей

Создайте внутренние представления (не включайте сырые артефакты в вывод):

- **Инвентарь требований**: Каждое функциональное + нефункциональное требование со стабильным ключом (вывести slug на основе императивной фразы; например, "User can upload file" → `user-can-upload-file`)
- **Инвентарь пользовательских историй/действий**: Дискретные действия пользователя с критериями приемки
- **Маппинг покрытия задач**: Сопоставьте каждую задачу с одним или несколькими требованиями или историями (вывод по ключевым словам / явным паттернам ссылок, таким как ID или ключевые фразы)
- **Набор правил конституции**: Извлеките имена принципов и нормативные утверждения MUST/SHOULD

### 4. Проходы обнаружения (Анализ с эффективным использованием токенов)

Сфокусируйтесь на находках с высоким сигналом. Ограничьтесь 50 находками всего; агрегируйте остаток в сводке переполнения.

#### A. Обнаружение дублирования

- Выявить почти дублирующиеся требования
- Пометить формулировки более низкого качества для консолидации

#### B. Обнаружение неоднозначности

- Пометить расплывчатые прилагательные (fast, scalable, secure, intuitive, robust), не имеющие измеримых критериев
- Пометить неразрешенные плейсхолдеры (TODO, TKTK, ???, `<placeholder>` и т.д.)

#### C. Недостаточная спецификация

- Требования с глаголами, но без объекта или измеримого результата
- Пользовательские истории без соответствия критериям приемки
- Задачи, ссылающиеся на файлы или компоненты, не определенные в spec/plan

#### D. Выравнивание конституции

- Любое требование или элемент плана, конфликтующий с принципом MUST
- Отсутствующие обязательные разделы или шлюзы качества из конституции

#### E. Пробелы покрытия

- Требования без связанных задач
- Задачи без сопоставленного требования/истории
- Нефункциональные требования, не отраженные в задачах (например, производительность, безопасность)

#### F. Несогласованность

- Дрейф терминологии (то же понятие названо по-разному в разных файлах)
- Сущности данных, упомянутые в плане, но отсутствующие в спецификации (или наоборот)
- Противоречия порядка задач (например, задачи интеграции перед базовыми задачами настройки без примечания о зависимости)
- Конфликтующие требования (например, одно требует Next.js, а другое указывает Vue)

### 5. Назначение серьезности

Используйте эту эвристику для приоритизации находок:

- **КРИТИЧНО**: Нарушает MUST конституции, отсутствует основной артефакт спецификации или требование с нулевым покрытием, блокирующее базовую функциональность
- **ВЫСОКАЯ**: Дублирующееся или конфликтующее требование, неоднозначный атрибут безопасности/производительности, непроверяемый критерий приемки
- **СРЕДНЯЯ**: Дрейф терминологии, отсутствующее покрытие нефункциональных задач, недостаточно специфицированный граничный случай
- **НИЗКАЯ**: Улучшения стиля/формулировки, незначительная избыточность, не влияющая на порядок выполнения

### 6. Создать компактный отчет об анализе

Выведите отчет Markdown (без записи файлов) со следующей структурой:

## Отчет об анализе спецификации

| ID | Категория | Серьезность | Местоположение(я) | Сводка | Рекомендация |
|----|-----------|-------------|-------------------|--------|--------------|
| A1 | Дублирование | ВЫСОКАЯ | spec.md:L120-134 | Два похожих требования ... | Объединить формулировки; сохранить более ясную версию |

(Добавьте одну строку на находку; генерируйте стабильные ID с префиксом начальной буквы категории.)

**Таблица сводки покрытия:**

| Ключ требования | Есть задача? | ID задач | Примечания |
|-----------------|-------------|----------|------------|

**Проблемы выравнивания конституции:** (если есть)

**Немаппированные задачи:** (если есть)

**Метрики:**

- Всего требований
- Всего задач
- Процент покрытия (требования с >=1 задачей)
- Количество неоднозначностей
- Количество дублирований
- Количество критических проблем

### 7. Предоставить следующие действия

В конце отчета выведите краткий блок Следующих действий:

- Если существуют КРИТИЧЕСКИЕ проблемы: Рекомендовать разрешить перед `/speckit.implement`
- Если только НИЗКАЯ/СРЕДНЯЯ: Пользователь может продолжить, но предоставьте предложения по улучшению
- Предоставьте явные предложения команд: например, "Запустить /speckit.specify с уточнением", "Запустить /speckit.plan для корректировки архитектуры", "Вручную отредактировать tasks.md для добавления покрытия 'performance-metrics'"

### 8. Предложить исправление

Спросите пользователя: "Хотите ли вы, чтобы я предложил конкретные правки исправления для топ N проблем?" (НЕ применяйте их автоматически.)

## Принципы работы

### Эффективность контекста

- **Минимальные токены с высоким сигналом**: Фокус на действенных находках, а не исчерпывающей документации
- **Прогрессивное раскрытие**: Загружайте артефакты инкрементально; не сбрасывайте все содержимое в анализ
- **Эффективный по токенам вывод**: Ограничьте таблицу находок 50 строками; суммируйте переполнение
- **Детерминированные результаты**: Повторный запуск без изменений должен давать согласованные ID и подсчеты

### Руководящие принципы анализа

- **НИКОГДА не изменяйте файлы** (это анализ только для чтения)
- **НИКОГДА не галлюцинируйте отсутствующие разделы** (если отсутствуют, сообщайте о них точно)
- **Приоритизируйте нарушения конституции** (они всегда КРИТИЧНЫ)
- **Используйте примеры вместо исчерпывающих правил** (цитируйте конкретные случаи, а не общие паттерны)
- **Элегантно сообщайте о нуле проблем** (выдайте отчет об успехе со статистикой покрытия)

## Контекст

$ARGUMENTS
